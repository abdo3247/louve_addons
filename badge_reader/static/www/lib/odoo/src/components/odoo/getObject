describe("jsonRpc tests", function() {

	var $httpBackend;
	var jsonRpc;

	beforeEach(module('starter'));

	beforeEach(inject(function(_jsonRpc_) {
		jsonRpc = _jsonRpc_;
	}));

	beforeEach(inject(function(_$httpBackend_) {
		$httpBackend = _$httpBackend_
	}));

 	afterEach (function () {
        $httpBackend.verifyNoOutstandingExpectation ();
        $httpBackend.verifyNoOutstandingRequest ();
    });
	function fail() {
		expect(true).toBe(false);
	}
	function success() {
		expect(true).toBe(true);
	}

	describe("session expiration", function () {
		function success(reason) {
			console.log(reason);
			expect(reason.title).toEqual("session_expired");
		}
		it("session expired v7", function () {
			$httpBackend.whenPOST('/web/session/get_session_info').respond ({
				jsonrpc:"2.0",
				id: null,
				error: { 
					message: "OpenERP WebClient Error",
					code: 300,
					data : {
						debug: "Client Traceback (most recent call last):  File \"/workspace/parts/odoo/addons/web/http.py\", line 204, in dispatch    response[\"result\"] = method(self, **self.params)  File \"/workspace/parts/odoo/addons/web/controllers/main.py\", line 1133, in call_kw    return self._call_kw(req, model, method, args, kwargs)  File \"/workspace/parts/odoo/addons/web/controllers/main.py\", line 1125, in _call_kw    return getattr(req.session.model(model), method)(*args, **kwargs)  File \"/workspace/parts/odoo/addons/web/session.py\", line 158, in model    raise SessionExpiredException(\"Session expired\")SessionExpiredException: Session expired",
						type: "client_exception"
					}
				}
			});
			jsonRpc.sendRequest('/web/session/get_session_info', {}).then(fail, success);;
			$httpBackend.flush();
		});

		it("session expired v8", function () {
			$httpBackend.whenPOST('/web/session/get_session_info').respond({
				jsonrpc:"2.0",
				id: null,
				error: {
					message: "Odoo Session Expired",
					code: 100
				},
				data: {
					deubg: "Traceback (most recent call last):  File \"/workspace/parts/odoo/openerp/http.py\", line 530, in _handle_exception    return super(JsonRequest, self)._handle_exception(exception)  File \"/workspace/parts/odoo/openerp/addons/base/ir/ir_http.py\", line 160, in _dispatch    auth_method = self._authenticate(func.routing[\"auth\"])  File \"/workspace/parts/odoo/openerp/addons/base/ir/ir_http.py\", line 93, in _authenticate    getattr(self, \"_auth_method_%s\" % auth_method)()  File \"/workspace/parts/odoo/openerp/addons/base/ir/ir_http.py\", line 70, in _auth_method_user    raise http.SessionExpiredException(\"Session expired\")SessionExpiredException: Session expired",
					message: "Session expired",
					name:"openerp.http.SessionExpiredException",
					arguments: ["Session expired"]
				}
			});
			jsonRpc.sendRequest('/web/session/get_session_info', {}).then(fail, success);;
			$httpBackend.flush();
		});
	});

});